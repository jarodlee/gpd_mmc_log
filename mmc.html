<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>eMMC System Monitor</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
body { font-family: Arial; margin: 20px; background: #f9f9f9; }
.card {
    padding: 12px;
    margin: 8px 0;
    background: #fff;
    border-radius: 10px;
    box-shadow: 0 2px 4px rgba(0,0,0,0.05);
}
.alert { background: #ffcccc !important; color: red; font-weight: bold; }
canvas { margin-top:20px; max-height:300px; }
</style>
</head>
<body>

<h2>GPD eMMC Professional Monitor: 注意温度 > 60°C  ARC > 3GB  内存 > 80% </h2>
<h3><a href="https://github.com/jarodlee/gpd_mmc_log">github link</a></h3>

<div class="card">累计写入: <b id="total_tb"></b> TB</div>
<div class="card" id="today_card">今日写入: <b id="today_gb"></b> GB</div>
<div class="card">平均每日写入: <b id="avg_daily_gb"></b> GB</div>
<div class="card">已使用寿命: <b id="life_percent"></b> %</div>
<div class="card">预计剩余寿命: <b id="remaining_years"></b></div>

<div class="card" id="battery_card">电池: <b id="battery"></b></div>
<div class="card">温度: <b id="temp"></b> °C</div>
<div class="card">无线IP: <b id="wifi_ip"></b></div>

<div class="card">CPU 使用率: <b id="cpu"></b> %</div>
<div class="card">内存使用率: <b id="mem"></b> %</div>
<div class="card">ZFS ARC 占用: <b id="arc"></b> GB</div>

<canvas id="chart"></canvas>

<script>

let chart;

function initChart() {
    const ctx = document.getElementById('chart').getContext('2d');
    chart = new Chart(ctx, {
        type: 'line',
        data: {
            labels: [],
            datasets: [{
                label: 'Total Written (GB)',
                data: [],
                fill: false,
                tension: 0.2
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false
        }
    });
}

function loadData() {
fetch('/mmc_data')
.then(res => res.json())
.then(data => {

document.getElementById("total_tb").innerText = data.total_tb;
document.getElementById("today_gb").innerText = data.today_gb;
document.getElementById("avg_daily_gb").innerText = data.avg_daily_gb;
document.getElementById("life_percent").innerText = data.life_used_percent;
document.getElementById("remaining_years").innerText =
    data.remaining_years ? data.remaining_years + " 年" : "学习中...";

if (data.alert)
    document.getElementById("today_card").classList.add("alert");

if (data.battery_percent !== null) {
    document.getElementById("battery").innerText =
        data.battery_percent + "% (" + data.battery_status + ")";
    if (data.battery_alert)
        document.getElementById("battery_card").classList.add("alert");
} else {
    document.getElementById("battery").innerText = "N/A";
}

document.getElementById("temp").innerText =
    data.temperature_c !== null ? data.temperature_c : "N/A";

document.getElementById("wifi_ip").innerText =
    data.wifi_ip !== null ? data.wifi_ip : "N/A";

document.getElementById("cpu").innerText =
    data.cpu_usage !== null ? data.cpu_usage : "N/A";

document.getElementById("mem").innerText =
    data.mem_used_percent !== null ? data.mem_used_percent : "N/A";

document.getElementById("arc").innerText =
    data.arc_size_gb !== null ? data.arc_size_gb : "N/A";

/* 更新图表 */
if (chart) {
    chart.data.labels = data.history.map(x =>
        new Date(x.time * 1000).toLocaleString()
    );
    chart.data.datasets[0].data = data.history.map(x => x.gb);
    chart.update();
}

});
}

initChart();
loadData();
setInterval(loadData, 5000);

</script>

</body>
</html>
